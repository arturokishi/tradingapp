{% extends "core/base.html" %}
{% load static %}

{% block content %}
<style>
    /* Dashboard specific styles */
    .dashboard-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 10px;
        flex-wrap: wrap;
    }
    
    .tab-button {
        padding: 10px 20px;
        background: none;
        border: none;
        border-radius: 5px 5px 0 0;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.3s;
    }
    
    .tab-button:hover {
        color: #2563eb;
        background: #f3f4f6;
    }
    
    .tab-button.active {
        color: #2563eb;
        border-bottom: 3px solid #2563eb;
    }
    
    .tab-content {
        display: none;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Loading spinner */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Card grid */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Form controls */
    .form-control {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin: 5px;
    }
    
    .btn-primary {
        background: #2563eb;
        color: white;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-info {
        background: #3b82f6;
        color: white;
    }
    
    .btn-warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
    }
    
    /* Table styles */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin-top: 20px;
    }
    
    .data-table th {
        background: #1e293b;
        color: white;
        padding: 12px;
        text-align: left;
    }
    
    .data-table td {
        padding: 10px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .data-table tr:hover {
        background: #f8fafc;
    }
    
    .positive { color: #10b981; font-weight: 600; }
    .negative { color: #ef4444; font-weight: 600; }
    .neutral { color: #6b7280; }
    
    /* News card */
    .news-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .news-bullish { border-left-color: #10b981; }
    .news-bearish { border-left-color: #ef4444; }
    .news-neutral { border-left-color: #fbbf24; }
    
    .news-source {
        font-size: 12px;
        color: #6b7280;
    }
    
    .news-date {
        font-size: 11px;
        color: #9ca3af;
    }
</style>

<h1>üöÄ Advanced Trading Platform</h1>

<div class="dashboard-tabs">
    <button class="tab-button active" onclick="switchTab('watchlist')">üìà Watchlist</button>
    <button class="tab-button" onclick="switchTab('analysis')">üîç Analysis</button>
    <button class="tab-button" onclick="switchTab('ranking')">üèÜ Ranking</button>
    <button class="tab-button" onclick="switchTab('backtest')">üß™ Backtest</button>
    <button class="tab-button" onclick="switchTab('iv')">üìä IV Analysis</button>
    <button class="tab-button" onclick="switchTab('trade-log')">üìã Trade Log</button>
</div>

<!-- Watchlist Tab -->
<div id="tab-watchlist" class="tab-content active">
    <div class="card">
        <h3>üìä Market Watchlist</h3>
        <button onclick="refreshWatchlist()" class="btn btn-primary">üîÑ Refresh Data</button>
        <div id="watchlist-loader" class="loader" style="display: none;"></div>
        <div id="watchlist-table"></div>
    </div>
</div>

<!-- Analysis Tab -->
<div id="tab-analysis" class="tab-content">
    <div class="card">
        <h3>üîç Stock Analysis</h3>
        <select id="analysis-ticker" class="form-control">
            {% for ticker in universe %}
            <option value="{{ ticker }}">{{ ticker }}</option>
            {% endfor %}
        </select>
        <button onclick="analyzeStock()" class="btn btn-primary">Analyze Stock</button>
        <div id="analysis-loader" class="loader" style="display: none;"></div>
        <div id="analysis-results"></div>
        <div id="analysis-news"></div>
    </div>
</div>

<!-- Ranking Tab -->
<div id="tab-ranking" class="tab-content">
    <div class="card">
        <h3>üèÜ Stock Ranking</h3>
        <select id="ranking-metric" class="form-control">
            <option value="Alpha Score">Alpha Score</option>
            <option value="News Sentiment">News Sentiment</option>
            <option value="IV Rank %">IV Rank %</option>
            <option value="Price">Price</option>
            <option value="Market Cap ($B)">Market Cap</option>
        </select>
        <button onclick="loadRanking()" class="btn btn-primary">Load Ranking</button>
        <div id="ranking-loader" class="loader" style="display: none;"></div>
        <div id="ranking-table"></div>
    </div>
</div>

<!-- Backtest Tab -->
<div id="tab-backtest" class="tab-content">
    <div class="card">
        <h3>üß™ Backtest Strategy</h3>
        <div style="display: grid; gap: 10px;">
            <select id="backtest-ticker" class="form-control">
                {% for ticker in universe %}
                <option value="{{ ticker }}">{{ ticker }}</option>
                {% endfor %}
            </select>
            
            <select id="backtest-signal" class="form-control">
                <option value="RSI">RSI</option>
                <option value="Volatility">Volatility</option>
                <option value="Alpha">Alpha</option>
                <option value="News Sentiment">News Sentiment</option>
            </select>
            
            <input type="number" id="backtest-threshold" class="form-control" placeholder="Threshold" value="30">
            <input type="number" id="backtest-lookback" class="form-control" placeholder="Lookback Days" value="20">
            <input type="number" id="backtest-hold" class="form-control" placeholder="Hold Days" value="5">
            <input type="number" id="backtest-size" class="form-control" placeholder="Position Size" value="1.0">
            
            <label>
                <input type="checkbox" id="use-alpha"> Use Alpha Filter
            </label>
            <label>
                <input type="checkbox" id="use-sentiment"> Use Sentiment Filter
            </label>
            
            <button onclick="runBacktest()" class="btn btn-success">Run Backtest</button>
        </div>
        <div id="backtest-loader" class="loader" style="display: none;"></div>
        <div id="backtest-results"></div>
    </div>
</div>

<!-- IV Analysis Tab -->
<div id="tab-iv" class="tab-content">
    <div class="card">
        <h3>üìä IV Rank Analysis</h3>
        <select id="iv-ticker" class="form-control">
            {% for ticker in universe %}
            <option value="{{ ticker }}">{{ ticker }}</option>
            {% endfor %}
        </select>
        <button onclick="analyzeIV()" class="btn btn-primary">Analyze IV</button>
        <div id="iv-loader" class="loader" style="display: none;"></div>
        <div id="iv-results"></div>
    </div>
</div>

<!-- Trade Log Tab -->
<div id="tab-trade-log" class="tab-content">
    <div class="card">
        <h3>üìã Trade Log</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button onclick="viewTradeLog()" class="btn btn-info">View Trades</button>
            <button onclick="exportTradeLog()" class="btn btn-warning">Export to CSV</button>
            <button onclick="clearTradeLog()" class="btn btn-danger">Clear Log</button>
        </div>
        <div id="trade-log-loader" class="loader" style="display: none;"></div>
        <div id="trade-log-summary"></div>
        <div id="trade-log-table"></div>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Load data for the tab
    if (tabName === 'watchlist') refreshWatchlist();
    if (tabName === 'ranking') loadRanking();
}

// Watchlist functions
async function refreshWatchlist() {
    const loader = document.getElementById('watchlist-loader');
    const table = document.getElementById('watchlist-table');
    
    loader.style.display = 'block';
    table.innerHTML = '';
    
    try {
        const response = await fetch('/api/trading/watchlist/');
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
            let html = '<table class="data-table"><tr>';
            
            // Headers
            Object.keys(data.data[0]).forEach(key => {
                html += `<th>${key}</th>`;
            });
            html += '</tr>';
            
            // Data rows
            data.data.forEach(row => {
                html += '<tr>';
                Object.entries(row).forEach(([key, val]) => {
                    let className = '';
                    if (typeof val === 'number') {
                        className = val > 0 ? 'positive' : val < 0 ? 'negative' : '';
                    }
                    html += `<td class="${className}">${typeof val === 'number' ? val.toFixed(2) : val}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            table.innerHTML = html;
        } else {
            table.innerHTML = '<p>No data available</p>';
        }
    } catch (error) {
        table.innerHTML = `<p class="negative">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

// Analysis function
async function analyzeStock() {
    const ticker = document.getElementById('analysis-ticker').value;
    const loader = document.getElementById('analysis-loader');
    const results = document.getElementById('analysis-results');
    const news = document.getElementById('analysis-news');
    
    loader.style.display = 'block';
    results.innerHTML = '';
    news.innerHTML = '';
    
    try {
        const response = await fetch(`/api/trading/analysis/?ticker=${ticker}`);
        const data = await response.json();
        
        if (data.success) {
            // Summary table
            let html = '<h4>Stock Summary</h4><table class="data-table">';
            Object.entries(data.summary).forEach(([key, val]) => {
                html += `<tr><td><strong>${key}</strong></td><td>${val}</td></tr>`;
            });
            html += '</table>';
            results.innerHTML = html;
            
            // News section
            if (data.news && data.news.length > 0) {
                let newsHtml = '<h4>Recent News</h4>';
                data.news.forEach(article => {
                    const sentimentClass = article.sentiment > 0.1 ? 'news-bullish' : 
                                          article.sentiment < -0.1 ? 'news-bearish' : 'news-neutral';
                    newsHtml += `
                        <div class="news-card ${sentimentClass}">
                            <strong>${article.headline}</strong><br>
                            <span class="news-source">${article.source}</span> | 
                            <span class="news-date">${new Date(article.published).toLocaleDateString()}</span><br>
                            <p>${article.description}</p>
                            <a href="${article.url}" target="_blank">Read More ‚Üí</a>
                        </div>
                    `;
                });
                news.innerHTML = newsHtml;
            }
        }
    } catch (error) {
        results.innerHTML = `<p class="negative">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

// Ranking function
async function loadRanking() {
    const metric = document.getElementById('ranking-metric').value;
    const loader = document.getElementById('ranking-loader');
    const table = document.getElementById('ranking-table');
    
    loader.style.display = 'block';
    table.innerHTML = '';
    
    try {
        const response = await fetch(`/api/trading/ranking/?metric=${metric}&limit=20`);
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
            let html = '<table class="data-table"><tr>';
            
            Object.keys(data.data[0]).forEach(key => {
                html += `<th>${key}</th>`;
            });
            html += '</tr>';
            
            data.data.forEach(row => {
                html += '<tr>';
                Object.values(row).forEach(val => {
                    let className = typeof val === 'number' && val > 0 ? 'positive' : 
                                   typeof val === 'number' && val < 0 ? 'negative' : '';
                    html += `<td class="${className}">${typeof val === 'number' ? val.toFixed(2) : val}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            table.innerHTML = html;
        }
    } catch (error) {
        table.innerHTML = `<p class="negative">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

// Backtest function
async function runBacktest() {
    const loader = document.getElementById('backtest-loader');
    const results = document.getElementById('backtest-results');
    
    loader.style.display = 'block';
    results.innerHTML = '';
    
    const data = {
        ticker: document.getElementById('backtest-ticker').value,
        signal_type: document.getElementById('backtest-signal').value,
        threshold: parseFloat(document.getElementById('backtest-threshold').value),
        lookback: parseInt(document.getElementById('backtest-lookback').value),
        hold_days: parseInt(document.getElementById('backtest-hold').value),
        position_size: parseFloat(document.getElementById('backtest-size').value),
        use_alpha: document.getElementById('use-alpha').checked,
        use_sentiment: document.getElementById('use-sentiment').checked
    };
    
    try {
        const response = await fetch('/api/trading/backtest/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        
        if (result.success) {
            let html = '<h4>Backtest Results</h4><table class="data-table">';
            Object.entries(result.stats).forEach(([key, val]) => {
                html += `<tr><td><strong>${key}</strong></td><td>${typeof val === 'number' ? val.toFixed(2) : val}</td></tr>`;
            });
            html += '</table>';
            results.innerHTML = html;
        } else {
            results.innerHTML = `<p class="negative">${result.error}</p>`;
        }
    } catch (error) {
        results.innerHTML = `<p class="negative">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

// IV Analysis
async function analyzeIV() {
    const ticker = document.getElementById('iv-ticker').value;
    const loader = document.getElementById('iv-loader');
    const results = document.getElementById('iv-results');
    
    loader.style.display = 'block';
    results.innerHTML = '';
    
    try {
        const response = await fetch(`/api/trading/iv/?ticker=${ticker}`);
        const data = await response.json();
        
        if (data.success) {
            let html = '<h4>IV Analysis</h4><table class="data-table">';
            Object.entries(data.iv_info).forEach(([key, val]) => {
                html += `<tr><td><strong>${key}</strong></td><td>${val}</td></tr>`;
            });
            html += '</table>';
            results.innerHTML = html;
        }
    } catch (error) {
        results.innerHTML = `<p class="negative">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

// Trade Log functions
async function viewTradeLog() {
    const loader = document.getElementById('trade-log-loader');
    const summary = document.getElementById('trade-log-summary');
    const table = document.getElementById('trade-log-table');
    
    loader.style.display = 'block';
    summary.innerHTML = '';
    table.innerHTML = '';
    
    try {
        const response = await fetch('/api/trading/trade-log/?action=view');
        const data = await response.json();
        
        if (data.success) {
            if (data.summary) {
                let summaryHtml = '<h4>Trade Summary</h4><table class="data-table">';
                Object.entries(data.summary).forEach(([key, val]) => {
                    summaryHtml += `<tr><td><strong>${key}</strong></td><td>${typeof val === 'number' ? val.toFixed(2) : val}</td></tr>`;
                });
                summaryHtml += '</table>';
                summary.innerHTML = summaryHtml;
            }
            
            if (data.trades.length > 0) {
                let tableHtml = '<h4>Recent Trades</h4><table class="data-table"><tr>';
                Object.keys(data.trades[0]).forEach(key => {
                    tableHtml += `<th>${key}</th>`;
                });
                tableHtml += '</tr>';
                data.trades.slice(0, 20).forEach(trade => {
                    tableHtml += '<tr>';
                    Object.values(trade).forEach(val => {
                        let className = '';
                        if (val === 'LONG' || (typeof val === 'number' && val > 0)) className = 'positive';
                        if (val === 'SHORT' || (typeof val === 'number' && val < 0)) className = 'negative';
                        tableHtml += `<td class="${className}">${val}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</table>';
                table.innerHTML = tableHtml;
            }
        }
    } catch (error) {
        table.innerHTML = `<p class="negative">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

async function exportTradeLog() {
    alert('Export functionality coming soon!');
}

async function clearTradeLog() {
    if (confirm('Are you sure you want to clear the trade log?')) {
        const response = await fetch('/api/trading/trade-log/?action=clear');
        const data = await response.json();
        if (data.success) {
            viewTradeLog();
        }
    }
}

// Auto-load watchlist on page load
document.addEventListener('DOMContentLoaded', () => {
    refreshWatchlist();
});
</script>
{% endblock %}