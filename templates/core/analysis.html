
{% extends "core/base.html" %}
{% load humanize %}

{% block content %}
<style>
    /* Card styling - matching dashboard */
    .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .card h3 {
        margin-top: 0;
        color: #1e293b;
        border-bottom: 2px solid #fbbf24;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    /* Analysis container */
    .analysis-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 0;
    }
    
    /* Form controls matching dashboard */
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        background: white;
    }
    
    .form-control:focus {
        border-color: #fbbf24;
        outline: none;
    }
    
    /* Button styling matching dashboard */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #2563eb;
        color: white;
    }
    
    .btn-primary:hover {
        background: #1d4ed8;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background: #059669;
    }
    
    /* Stock selector styling */
    .stock-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    
    .stock-selector > div {
        min-width: 150px;
    }
    
    .stock-selector button {
        background: #fbbf24;
        color: #1f2933;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
        transition: all 0.3s;
    }
    
    .stock-selector button:hover {
        background: #f59e0b;
    }
    
    /* Parameter labels */
    .parameter-label {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }
    
    /* Metrics grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .metric-card {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #2563eb;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .metric-label {
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-value {
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        margin-top: 5px;
    }
    
    .metric-value.positive { color: #10b981; }
    .metric-value.negative { color: #ef4444; }
    
    /* News section */
    .news-section {
        grid-column: span 2;
    }
    
    .news-card {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .news-card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .news-bullish { border-left-color: #10b981; }
    .news-bearish { border-left-color: #ef4444; }
    .news-neutral { border-left-color: #fbbf24; }
    
    .news-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #1e293b;
    }
    
    .news-meta {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 8px;
    }
    
    .news-link {
        color: #2563eb;
        text-decoration: none;
        font-size: 12px;
        font-weight: 500;
    }
    
    .news-link:hover {
        text-decoration: underline;
    }
    
    /* Loading spinner */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #fbbf24;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* MC Results */
    .mc-results {
        background: #f8fafc;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    
    .mc-results h4 {
        color: #1e293b;
        margin-top: 0;
        margin-bottom: 15px;
    }
    
    /* Table styling - matching dashboard */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    th {
        background-color: #1e293b;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    td {
        padding: 10px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    tr:hover {
        background-color: #f8fafc;
    }
    
    /* Risk colors */
    .risk-high { color: #ef4444; font-weight: 600; }
    .risk-medium { color: #f59e0b; font-weight: 600; }
    .risk-low { color: #10b981; font-weight: 600; }

    /* Navbar styling */
.navbar {
    background-color: #111827;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.navbar-links {
    display: flex;
    gap: 20px;
}

.navbar a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
}

.navbar a:hover {
    color: #fbbf24;
}

.nav-button {
    background-color: #fbbf24;
    color: #1f2933 !important;
    padding: 8px 16px;
    border-radius: 5px;
    font-weight: 600;
}

.nav-button:hover {
    background-color: #f59e0b;
    color: #1f2933 !important;
}
</style>



<!-- Full Navigation Bar -->
<div class="navbar">
    <div class="navbar-links">
        <a href="/">Home</a>
        <a href="/dashboard/">Dashboard</a>
        <a href="/analysis/">Analysis</a>
        <a href="/ranking/">Ranking</a>
        <a href="/backtest/">Backtest</a>
        <a href="/iv/">IV Analysis</a>
        <a href="/trade-log/">Trade Log</a>
        <a href="/trading/trading/" class="highlight">üöÄ Trading Platform</a>  <!-- NEW -->
    </div>
    <a href="/" class="nav-button">üè† Volver al Inicio</a>
</div>


<div class="container" style="padding: 20px;">
    <!-- Stock Analysis Card -->
    <div class="card">
        <h3>üìà Stock Analysis</h3>
        
        <div class="stock-selector">
            <div style="flex: 2;">
                <select id="ticker" class="form-control">
                    {% for ticker in universe %}
                    <option value="{{ ticker }}">{{ ticker }}</option>
                    {% endfor %}
                </select>
                <div class="parameter-label">Select stock ticker</div>
            </div>
            <button onclick="analyzeStock()">Analyze Stock</button>
        </div>
        
        <div id="analysis-loader" class="loader" style="display: none;"></div>
        
        <div id="analysis-results"></div>
    </div>
    
    <!-- Monte Carlo Card -->
    <div class="card">
        <h3>üé≤ Monte Carlo Simulation</h3>
        
        <div class="stock-selector">
            <div style="flex: 1;">
                <select id="mc-ticker" class="form-control">
                    {% for ticker in universe %}
                    <option value="{{ ticker }}">{{ ticker }}</option>
                    {% endfor %}
                </select>
                <div class="parameter-label">Stock ticker</div>
            </div>
            
            <div style="flex: 1;">
                <input type="number" id="mc-simulations" class="form-control" value="1000" min="100" max="10000">
                <div class="parameter-label">Number of simulations</div>
            </div>
            
            <div style="flex: 1;">
                <input type="number" id="mc-years" class="form-control" value="5" min="1" max="30">
                <div class="parameter-label">Years to simulate</div>
            </div>
            
            <div style="flex: 1;">
                <input type="number" id="mc-investment" class="form-control" value="10000" min="1000" step="1000">
                <div class="parameter-label">Initial investment ($)</div>
            </div>
            
            <button onclick="runMonteCarlo()">Run Simulation</button>
        </div>
        
        <div id="mc-loader" class="loader" style="display: none;"></div>
        <div id="mc-results"></div>
    </div>
    
    <!-- News Section -->
    <div class="card news-section">
        <h3>üì∞ Recent News & Sentiment</h3>
        <div id="news-results"></div>
    </div>
</div>

<script>
async function analyzeStock() {
    const ticker = document.getElementById('ticker').value;
    const loader = document.getElementById('analysis-loader');
    const results = document.getElementById('analysis-results');
    const news = document.getElementById('news-results');
    
    loader.style.display = 'block';
    results.innerHTML = '';
    news.innerHTML = '';
    
    try {
        const response = await fetch(`/api/trading/analysis/?ticker=${ticker}`);
        const data = await response.json();
        
        if (data.success) {
            // Stock metrics
            let html = '<div class="metrics-grid">';
            for (let [key, value] of Object.entries(data.summary)) {
                let valueClass = '';
                if (key.includes('Score') || key.includes('Sentiment')) {
                    valueClass = value > 0.1 ? 'positive' : value < -0.1 ? 'negative' : '';
                }
                if (key.includes('Return') || key.includes('Change')) {
                    valueClass = value > 0 ? 'positive' : value < 0 ? 'negative' : '';
                }
                html += `
                    <div class="metric-card">
                        <div class="metric-label">${key}</div>
                        <div class="metric-value ${valueClass}">${value}</div>
                    </div>
                `;
            }
            html += '</div>';
            results.innerHTML = html;
            
            // News
            if (data.news && data.news.length > 0) {
                let newsHtml = '';
                data.news.forEach(article => {
                    const sentimentClass = article.sentiment > 0.1 ? 'news-bullish' : 
                                          article.sentiment < -0.1 ? 'news-bearish' : 'news-neutral';
                    newsHtml += `
                        <div class="news-card ${sentimentClass}">
                            <div class="news-title">${article.headline}</div>
                            <div class="news-meta">${article.source} | ${new Date(article.published).toLocaleDateString()}</div>
                            <p style="font-size: 13px; color: #475569; margin-bottom: 10px;">${article.description}</p>
                            <a href="${article.url}" target="_blank" class="news-link">Read Full Article ‚Üí</a>
                        </div>
                    `;
                });
                news.innerHTML = newsHtml;
            } else {
                news.innerHTML = '<p style="text-align: center; padding: 40px; color: #9ca3af;">No recent news found.</p>';
            }
        } else {
            results.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Error: ${data.error}</p>`;
        }
    } catch (error) {
        results.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

async function runMonteCarlo() {
    const ticker = document.getElementById('mc-ticker').value;
    const simulations = document.getElementById('mc-simulations').value;
    const years = document.getElementById('mc-years').value;
    const investment = parseFloat(document.getElementById('mc-investment').value);
    
    const loader = document.getElementById('mc-loader');
    const results = document.getElementById('mc-results');
    
    loader.style.display = 'block';
    results.innerHTML = '';
    
    try {
        const response = await fetch(`/api/trading/monte-carlo/?ticker=${ticker}&simulations=${simulations}&years=${years}&investment=${investment}`);
        const data = await response.json();
        
        if (data.success) {
            // Calculate dollar values
            const lowerBound = investment * data.confidence_interval.lower;
            const upperBound = investment * data.confidence_interval.upper;
            const medianValue = investment * data.percentiles['50'];
            
            // Risk classification
            const riskLevel = data.var_95 > investment * 0.2 ? 'high' : data.var_95 > investment * 0.1 ? 'medium' : 'low';
            
            let html = `
                <div class="mc-results">
                    <h4>üìä Simulation Results</h4>
                    <p style="color: #64748b; margin-bottom: 20px;">
                        <strong>Parameters:</strong> ${ticker} | ${simulations} simulations | ${years} years | $${investment.toFixed(2)} investment
                    </p>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Initial Investment</div>
                            <div class="metric-value">$${investment.toFixed(2)}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">95% Confidence Interval</div>
                            <div class="metric-value">$${lowerBound.toFixed(2)} - $${upperBound.toFixed(2)}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Median Outcome</div>
                            <div class="metric-value">$${medianValue.toFixed(2)}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Value at Risk (95%)</div>
                            <div class="metric-value ${riskLevel === 'high' ? 'negative' : riskLevel === 'medium' ? '' : 'positive'}">
                                $${data.var_95.toFixed(2)}
                                <span style="font-size: 11px; display: block; color: #666;">
                                    Risk: ${riskLevel.toUpperCase()}
                                </span>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Conditional VaR (95%)</div>
                            <div class="metric-value negative">$${data.cvar_95.toFixed(2)}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">10th Percentile</div>
                            <div class="metric-value negative">$${(investment * data.percentiles['10']).toFixed(2)}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">90th Percentile</div>
                            <div class="metric-value positive">$${(investment * data.percentiles['90']).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f1f5f9; border-radius: 8px; color: #1e293b;">
                        <strong style="display: block; margin-bottom: 10px;">üìã Interpretation:</strong>
                        ‚Ä¢ There's a 95% chance your investment will be between <strong>$${lowerBound.toFixed(2)}</strong> and <strong>$${upperBound.toFixed(2)}</strong><br>
                        ‚Ä¢ In the worst 5% of cases, you could lose up to <strong>$${data.var_95.toFixed(2)}</strong><br>
                        ‚Ä¢ The median outcome is <strong>$${medianValue.toFixed(2)}</strong><br>
                        ‚Ä¢ Your best case (90th percentile) is <strong>$${(investment * data.percentiles['90']).toFixed(2)}</strong>
                    </div>
                </div>
            `;
            results.innerHTML = html;
        } else {
            results.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Error: ${data.error}</p>`;
        }
    } catch (error) {
        results.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Error: ${error}</p>`;
    }
    
    loader.style.display = 'none';
}

// Load default analysis on page load
document.addEventListener('DOMContentLoaded', () => {
    analyzeStock();
});
</script>
{% endblock %}